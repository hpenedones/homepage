<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Hugo Penedones - Blog</title>

    <link rel="stylesheet" href="../stylesheets/styles.css">
    <link rel="stylesheet" href="../stylesheets/pygment_trac.css">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Arvo:ital,wght@0,400;0,700;1,400&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Arvo:ital,wght@0,400;0,700;1,400&display=swap"></noscript>
    <script defer src="../javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Blog by Hugo Penedones — thoughts on Machine Learning, AI, science and technology.">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Hugo Penedones</h1>

        <img src="../images/hugo.jpg" width="120" height="120" alt="Hugo Penedones"/>
        <p><a href="index.html">← Back to blog</a></p>
      </header>
      <section role="main">
        <div id="post-content">
          <p>Loading...</p>
        </div>
      </section>
      <footer>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script>
      // Configure marked to add IDs to headings for anchor links
      marked.use({
        renderer: {
          heading(text, level) {
            // `text` may include HTML entities (e.g., &#39;). Decode first so heading IDs
            // match markdown in-page links such as #dry-dont-repeat-yourself.
            const decodedText = (() => {
              const textarea = document.createElement('textarea');
              textarea.innerHTML = text;
              return textarea.value;
            })();
            // Generate slug from heading text (similar to GitHub-style slugs)
            const slug = decodedText
              .toLowerCase()
              .replace(/[^\w\s-]/g, '') // Remove special characters except spaces and hyphens
              .replace(/\s+/g, '-')      // Replace spaces with hyphens
              .replace(/-+/g, '-')       // Replace multiple hyphens with single hyphen
              .replace(/^-+|-+$/g, '');  // Trim hyphens from start and end

            return `<h${level} id="${slug}">${text}</h${level}>\n`;
          }
        }
      });

      // Convert slug to markdown file path
      // Slug format: YYYY-MM-DD-title
      // File path: YYYY/YYYY-MM-DD-title.md
      function slugToFilePath(slug) {
        const year = slug.substring(0, 4);
        return `${year}/${slug}.md`;
      }

      function getPostSlugFromHash() {
        const hashValue = window.location.hash.substring(1);
        const match = hashValue.match(/^\d{4}-\d{2}-\d{2}-[\w-]+/);
        return match ? match[0] : '';
      }

      async function loadPost() {
        // Get the slug from the URL hash (format: #2023-05-30-programming-at-inductiva)
        const slug = getPostSlugFromHash();

        if (!slug) {
          document.getElementById('post-content').innerHTML = '<p>No post specified.</p>';
          return;
        }

        const file = slugToFilePath(slug);

        try {
          const response = await fetch(file);
          if (!response.ok) {
            throw new Error('Post not found');
          }

          const markdown = await response.text();
          const html = marked.parse(markdown);
          const postContent = document.getElementById('post-content');
          postContent.innerHTML = html;
          // Blog post links are injected after page load, so ensure external links open in a new tab.
          const links = postContent.querySelectorAll('a[href]');
          for (const link of links) {
            const href = link.getAttribute('href');
            if (!href || href.charAt(0) === '#' || href.indexOf('mailto:') === 0 || href.indexOf('tel:') === 0) {
              continue;
            }
            if (link.hostname && link.hostname !== window.location.hostname) {
              link.setAttribute('target', '_blank');
              link.setAttribute('rel', 'noopener noreferrer');
            }
          }
          if (!postContent.dataset.anchorHandlerSet) {
            // Keep the post slug in the URL hash (shareable link) while still supporting
            // in-post navigation to section anchors.
            postContent.addEventListener('click', (event) => {
              const anchorLink = event.target.closest('a[href^="#"]');
              if (!anchorLink) {
                return;
              }

              const anchorId = anchorLink.getAttribute('href').substring(1);
              const target = document.getElementById(anchorId);
              if (!target) {
                return;
              }

              event.preventDefault();
              target.scrollIntoView();
            });
            postContent.dataset.anchorHandlerSet = 'true';
          }
        } catch (error) {
          document.getElementById('post-content').innerHTML = '<p>Error loading post: ' + error.message + '</p>';
        }
      }

      // Load post on page load and when hash changes to another post slug
      loadPost();
      window.addEventListener('hashchange', () => {
        if (getPostSlugFromHash()) {
          loadPost();
        }
      });
    </script>

  </body>
</html>
