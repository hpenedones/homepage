name: Check for Broken Links

on:

  # Run automatically once a week (every Monday at 08:00 UTC)
  schedule:
    - cron: '0 8 * * 1'

  # Allow manual trigger
  workflow_dispatch:


jobs:
  link-checker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check links in HTML and Markdown files
        uses: lycheeverse/lychee-action@v1
        with:
          # Check HTML and Markdown files
          args: |
            --verbose
            --no-progress
            --config .lychee.toml
            '**/*.html' '**/*.md'

          # Fail the workflow if broken links are found
          fail: true

          # Output format
          format: markdown

          # Job summary output
          jobSummary: true

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_title = 'ðŸ”— Broken Links Detected';
            const workflowUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const workflowFileUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/blob/${context.ref.replace('refs/heads/', '')}/.github/workflows/broken-links.yml`;

            const issue_body = `Broken links were detected in the website.

            **Workflow Run:** ${workflowUrl}

            Please review the links and fix any that are broken.

            This issue was automatically created by the [broken-links workflow](${workflowFileUrl}).`;

            try {
              // Check if an issue already exists
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: ['broken-links']
              });

              if (issues.data.length === 0) {
                // Create new issue
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issue_title,
                  body: issue_body,
                  labels: ['broken-links', 'automated']
                });
              } else {
                // Add comment to existing issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issues.data[0].number,
                  body: `Another broken link check failed.\n\n**Workflow Run:** ${workflowUrl}`
                });
              }
            } catch (error) {
              // Issues might be disabled for this repository
              console.log('Could not create issue. Issues may be disabled for this repository.');
              console.log(`Error: ${error.message}`);
            }
